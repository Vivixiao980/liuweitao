<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MiniMaxè¯­éŸ³å…‹éš†æµ‹è¯• - æŒ‰å®˜æ–¹æ–‡æ¡£å®ç°</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .main-content {
            padding: 40px;
        }

        .step {
            margin-bottom: 40px;
            padding: 30px;
            background: #f8fafc;
            border-radius: 15px;
            border-left: 5px solid #4f46e5;
        }

        .step-title {
            font-size: 1.3rem;
            color: #374151;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .step-description {
            color: #6b7280;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .btn {
            background: #4f46e5;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px 10px 10px 0;
        }

        .btn:hover {
            background: #4338ca;
            transform: translateY(-2px);
        }

        .btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }

        .btn-success {
            background: #10b981;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-danger {
            background: #ef4444;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .file-input {
            display: none;
        }

        .upload-area {
            border: 2px dashed #cbd5e1;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            margin: 20px 0;
            background: white;
        }

        .upload-area.dragover {
            border-color: #4f46e5;
            background: #f0f9ff;
        }

        .file-list {
            margin-top: 20px;
        }

        .file-item {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .file-info {
            flex: 1;
        }

        .file-name {
            font-weight: 600;
            color: #374151;
        }

        .file-size {
            color: #6b7280;
            font-size: 0.9rem;
        }

        .log-area {
            background: #1f2937;
            color: #f9fafb;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            height: 300px;
            overflow-y: auto;
            margin-top: 20px;
        }

        .input-group {
            margin: 15px 0;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #374151;
        }

        .input-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 1rem;
        }

        .status {
            padding: 10px 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: 500;
        }

        .status.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #10b981;
        }

        .status.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #ef4444;
        }

        .status.info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #3b82f6;
        }

        .api-info {
            background: #fffbeb;
            border: 1px solid #f59e0b;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .api-info h3 {
            color: #92400e;
            margin-bottom: 10px;
        }

        .api-info code {
            background: #f3f4f6;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¤ MiniMaxè¯­éŸ³å…‹éš†æµ‹è¯•</h1>
            <p>æŒ‰ç…§å®˜æ–¹æ–‡æ¡£é€æ­¥å®ç°è¯­éŸ³å…‹éš†åŠŸèƒ½</p>
        </div>

        <div class="main-content">
            <!-- APIä¿¡æ¯è¯´æ˜ -->
            <div class="api-info">
                <h3>ğŸ“‹ å®˜æ–¹APIæµç¨‹</h3>
                <p><strong>æ­¥éª¤1ï¼š</strong>é€šè¿‡Fileæ¥å£ä¸Šä¼ æ–‡ä»¶ â†’ <code>https://api.minimaxi.com/v1/files/upload</code></p>
                <p><strong>æ­¥éª¤2ï¼š</strong>è°ƒç”¨è¯­éŸ³å…‹éš†æ¥å£ â†’ <code>https://api.minimaxi.com/v1/voice_clone</code></p>
                <p><strong>æ­¥éª¤3ï¼š</strong>ä½¿ç”¨å…‹éš†çš„voice_idè¿›è¡Œè¯­éŸ³åˆæˆ</p>
            </div>

            <!-- æ­¥éª¤1ï¼šä¸Šä¼ æ–‡ä»¶ -->
            <div class="step">
                <div class="step-title">ğŸ“ æ­¥éª¤1ï¼šä¸Šä¼ éŸ³é¢‘æ–‡ä»¶</div>
                <div class="step-description">
                    é€‰æ‹©éŸ³é¢‘æ–‡ä»¶å¹¶ä¸Šä¼ åˆ°MiniMaxæœåŠ¡å™¨ï¼Œè·å–file_idã€‚
                    æ”¯æŒæ ¼å¼ï¼šMP3, WAV, M4Aç­‰ï¼Œå»ºè®®æ–‡ä»¶å¤§å°åœ¨10MBä»¥å†…ã€‚
                </div>
                
                <div class="upload-area" id="uploadArea">
                    <div style="font-size: 2rem; margin-bottom: 10px;">ğŸ“</div>
                    <p>ç‚¹å‡»é€‰æ‹©æ–‡ä»¶æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°è¿™é‡Œ</p>
                    <input type="file" id="audioFiles" class="file-input" multiple accept="audio/*">
                    <button class="btn" onclick="document.getElementById('audioFiles').click()">é€‰æ‹©éŸ³é¢‘æ–‡ä»¶</button>
                </div>

                <div class="file-list" id="fileList"></div>
                
                <button class="btn btn-success" id="uploadBtn" onclick="uploadFiles()" disabled>
                    ğŸ“¤ ä¸Šä¼ æ–‡ä»¶è·å–file_id
                </button>
                
                <div id="uploadStatus"></div>
                <div id="fileIds"></div>
            </div>

            <!-- æ­¥éª¤2ï¼šåˆ›å»ºè¯­éŸ³å…‹éš† -->
            <div class="step">
                <div class="step-title">ğŸ¯ æ­¥éª¤2ï¼šåˆ›å»ºè¯­éŸ³å…‹éš†</div>
                <div class="step-description">
                    ä½¿ç”¨ä¸Šä¼ çš„æ–‡ä»¶IDåˆ›å»ºè¯­éŸ³å…‹éš†ï¼Œç”Ÿæˆè‡ªå®šä¹‰çš„voice_idã€‚
                </div>
                
                <div class="input-group">
                    <label for="voiceId">è‡ªå®šä¹‰Voice IDï¼š</label>
                    <input type="text" id="voiceId" placeholder="ä¾‹å¦‚ï¼šliming_voice_20241210" value="">
                </div>
                
                <button class="btn btn-success" id="cloneBtn" onclick="createVoiceClone()" disabled>
                    ğŸ¤ åˆ›å»ºè¯­éŸ³å…‹éš†
                </button>
                
                <div id="cloneStatus"></div>
            </div>

            <!-- æ­¥éª¤3ï¼šæµ‹è¯•è¯­éŸ³åˆæˆ -->
            <div class="step">
                <div class="step-title">ğŸ”Š æ­¥éª¤3ï¼šæµ‹è¯•è¯­éŸ³åˆæˆ</div>
                <div class="step-description">
                    ä½¿ç”¨å…‹éš†çš„voice_idè¿›è¡Œè¯­éŸ³åˆæˆæµ‹è¯•ã€‚
                </div>
                
                <div class="input-group">
                    <label for="testText">æµ‹è¯•æ–‡æœ¬ï¼š</label>
                    <input type="text" id="testText" placeholder="è¾“å…¥è¦åˆæˆçš„æ–‡æœ¬" value="ä½ å¥½ï¼Œæˆ‘æ˜¯ç¤¼æ˜è€å¸ˆï¼Œå¾ˆé«˜å…´ä¸ºä½ æœåŠ¡ï¼">
                </div>
                
                <button class="btn btn-success" id="synthesizeBtn" onclick="testSynthesis()" disabled>
                    ğŸµ æµ‹è¯•è¯­éŸ³åˆæˆ
                </button>
                
                <div id="synthesisStatus"></div>
                <audio id="audioPlayer" controls style="width: 100%; margin-top: 20px; display: none;"></audio>
            </div>

            <!-- æ“ä½œæ—¥å¿— -->
            <div class="step">
                <div class="step-title">ğŸ“‹ æ“ä½œæ—¥å¿—</div>
                <div class="log-area" id="logArea"></div>
                <button class="btn" onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
            </div>
        </div>
    </div>

    <script>
        let uploadedFileIds = [];
        let createdVoiceId = '';

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // ç”Ÿæˆé»˜è®¤voice_id
            document.getElementById('voiceId').value = `liming_voice_${Date.now()}`;
            
            // æ–‡ä»¶é€‰æ‹©äº‹ä»¶
            document.getElementById('audioFiles').addEventListener('change', handleFileSelect);
            
            // æ‹–æ‹½ä¸Šä¼ 
            const uploadArea = document.getElementById('uploadArea');
            uploadArea.addEventListener('dragover', handleDragOver);
            uploadArea.addEventListener('drop', handleDrop);
            uploadArea.addEventListener('dragleave', handleDragLeave);
            
            log('ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
        });

        function handleFileSelect(event) {
            const files = Array.from(event.target.files);
            displayFiles(files);
        }

        function handleDragOver(event) {
            event.preventDefault();
            event.currentTarget.classList.add('dragover');
        }

        function handleDrop(event) {
            event.preventDefault();
            event.currentTarget.classList.remove('dragover');
            const files = Array.from(event.dataTransfer.files);
            displayFiles(files);
        }

        function handleDragLeave(event) {
            event.currentTarget.classList.remove('dragover');
        }

        function displayFiles(files) {
            const fileList = document.getElementById('fileList');
            const uploadBtn = document.getElementById('uploadBtn');
            
            fileList.innerHTML = '';
            
            files.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
                    <div class="file-info">
                        <div class="file-name">${file.name}</div>
                        <div class="file-size">${(file.size / 1024 / 1024).toFixed(2)} MB</div>
                    </div>
                    <button class="btn btn-danger" onclick="removeFile(${index})">ç§»é™¤</button>
                `;
                fileList.appendChild(fileItem);
            });
            
            uploadBtn.disabled = files.length === 0;
            log(`é€‰æ‹©äº† ${files.length} ä¸ªæ–‡ä»¶`);
        }

        function removeFile(index) {
            const fileInput = document.getElementById('audioFiles');
            const files = Array.from(fileInput.files);
            files.splice(index, 1);
            
            // é‡æ–°è®¾ç½®æ–‡ä»¶åˆ—è¡¨
            const dt = new DataTransfer();
            files.forEach(file => dt.items.add(file));
            fileInput.files = dt.files;
            
            displayFiles(files);
        }

        async function uploadFiles() {
            const fileInput = document.getElementById('audioFiles');
            const files = Array.from(fileInput.files);
            
            if (files.length === 0) {
                showStatus('uploadStatus', 'error', 'è¯·å…ˆé€‰æ‹©éŸ³é¢‘æ–‡ä»¶');
                return;
            }

            const uploadBtn = document.getElementById('uploadBtn');
            uploadBtn.disabled = true;
            uploadBtn.textContent = 'ä¸Šä¼ ä¸­...';
            
            showStatus('uploadStatus', 'info', 'æ­£åœ¨ä¸Šä¼ æ–‡ä»¶...');
            log('å¼€å§‹ä¸Šä¼ æ–‡ä»¶åˆ°MiniMaxæœåŠ¡å™¨');

            try {
                uploadedFileIds = [];
                
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    log(`ä¸Šä¼ æ–‡ä»¶ ${i + 1}/${files.length}: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)}MB)`);
                    
                    const formData = new FormData();
                    formData.append('file', file);
                    formData.append('purpose', 'voice_clone');

                    const response = await fetch('/api/upload-file', {
                        method: 'POST',
                        body: formData
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`æ–‡ä»¶ä¸Šä¼ å¤±è´¥: ${response.status} - ${errorText}`);
                    }

                    const result = await response.json();
                    log(`æ–‡ä»¶ä¸Šä¼ æˆåŠŸ: ${JSON.stringify(result)}`);
                    
                                    if (result.file_id) {
                    uploadedFileIds.push(result.file_id);
                    log(`è·å¾—file_id: ${result.file_id}`);
                    if (result.source === 'local') {
                        log(`æ³¨æ„: ä½¿ç”¨æœ¬åœ°é™çº§æ–¹æ¡ˆ - ${result.message}`);
                    }
                } else {
                    throw new Error('æœªè·å¾—file_id');
                }
                }

                showStatus('uploadStatus', 'success', `æˆåŠŸä¸Šä¼  ${files.length} ä¸ªæ–‡ä»¶`);
                document.getElementById('fileIds').innerHTML = `
                    <div class="status info">
                        <strong>è·å¾—çš„file_idåˆ—è¡¨ï¼š</strong><br>
                        ${uploadedFileIds.map(id => `<code>${id}</code>`).join('<br>')}
                    </div>
                `;
                
                // å¯ç”¨å…‹éš†æŒ‰é’®
                document.getElementById('cloneBtn').disabled = false;
                log(`æ–‡ä»¶ä¸Šä¼ å®Œæˆï¼Œå…±è·å¾— ${uploadedFileIds.length} ä¸ªfile_id`);
                
            } catch (error) {
                log(`æ–‡ä»¶ä¸Šä¼ å¤±è´¥: ${error.message}`);
                showStatus('uploadStatus', 'error', `ä¸Šä¼ å¤±è´¥: ${error.message}`);
            } finally {
                uploadBtn.disabled = false;
                uploadBtn.textContent = 'ğŸ“¤ ä¸Šä¼ æ–‡ä»¶è·å–file_id';
            }
        }

        async function createVoiceClone() {
            const voiceId = document.getElementById('voiceId').value.trim();
            
            if (!voiceId) {
                showStatus('cloneStatus', 'error', 'è¯·è¾“å…¥è‡ªå®šä¹‰Voice ID');
                return;
            }

            if (uploadedFileIds.length === 0) {
                showStatus('cloneStatus', 'error', 'è¯·å…ˆä¸Šä¼ æ–‡ä»¶è·å–file_id');
                return;
            }

            const cloneBtn = document.getElementById('cloneBtn');
            cloneBtn.disabled = true;
            cloneBtn.textContent = 'åˆ›å»ºä¸­...';
            
            showStatus('cloneStatus', 'info', 'æ­£åœ¨åˆ›å»ºè¯­éŸ³å…‹éš†...');
            log(`å¼€å§‹åˆ›å»ºè¯­éŸ³å…‹éš†ï¼Œvoice_id: ${voiceId}, file_ids: ${uploadedFileIds.join(', ')}`);

            try {
                const response = await fetch('/api/create-voice-clone', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        voice_id: voiceId,
                        file_ids: uploadedFileIds
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`è¯­éŸ³å…‹éš†å¤±è´¥: ${response.status} - ${errorText}`);
                }

                const result = await response.json();
                log(`è¯­éŸ³å…‹éš†æˆåŠŸ: ${JSON.stringify(result)}`);
                
                createdVoiceId = voiceId;
                showStatus('cloneStatus', 'success', `è¯­éŸ³å…‹éš†åˆ›å»ºæˆåŠŸï¼Voice ID: ${voiceId}`);
                
                // å¯ç”¨åˆæˆæµ‹è¯•æŒ‰é’®
                document.getElementById('synthesizeBtn').disabled = false;
                log(`è¯­éŸ³å…‹éš†åˆ›å»ºå®Œæˆï¼Œå¯ä»¥è¿›è¡Œåˆæˆæµ‹è¯•`);
                
            } catch (error) {
                log(`è¯­éŸ³å…‹éš†å¤±è´¥: ${error.message}`);
                showStatus('cloneStatus', 'error', `åˆ›å»ºå¤±è´¥: ${error.message}`);
            } finally {
                cloneBtn.disabled = false;
                cloneBtn.textContent = 'ğŸ¤ åˆ›å»ºè¯­éŸ³å…‹éš†';
            }
        }

        async function testSynthesis() {
            const testText = document.getElementById('testText').value.trim();
            
            if (!testText) {
                showStatus('synthesisStatus', 'error', 'è¯·è¾“å…¥æµ‹è¯•æ–‡æœ¬');
                return;
            }

            if (!createdVoiceId) {
                showStatus('synthesisStatus', 'error', 'è¯·å…ˆåˆ›å»ºè¯­éŸ³å…‹éš†');
                return;
            }

            const synthesizeBtn = document.getElementById('synthesizeBtn');
            synthesizeBtn.disabled = true;
            synthesizeBtn.textContent = 'åˆæˆä¸­...';
            
            showStatus('synthesisStatus', 'info', 'æ­£åœ¨ç”Ÿæˆè¯­éŸ³...');
            log(`å¼€å§‹è¯­éŸ³åˆæˆæµ‹è¯•ï¼Œæ–‡æœ¬: "${testText}", voice_id: ${createdVoiceId}`);

            try {
                const response = await fetch('/api/test-synthesis', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        text: testText,
                        voice_id: createdVoiceId
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`è¯­éŸ³åˆæˆå¤±è´¥: ${response.status} - ${errorText}`);
                }

                const result = await response.json();
                log(`è¯­éŸ³åˆæˆå“åº”: ${JSON.stringify(result)}`);
                
                if (result.success && result.audio_url) {
                    let statusMessage = 'è¯­éŸ³åˆæˆæˆåŠŸï¼';
                    if (result.source === 'local') {
                        statusMessage = 'ä½¿ç”¨æœ¬åœ°éŸ³é¢‘æ ·æœ¬æ’­æ”¾ï¼';
                    } else if (result.source === 'fallback') {
                        statusMessage = 'ä½¿ç”¨é»˜è®¤éŸ³è‰²åˆæˆæˆåŠŸï¼';
                    }
                    
                    showStatus('synthesisStatus', 'success', statusMessage);
                    
                    // æ˜¾ç¤ºé¢å¤–ä¿¡æ¯
                    if (result.message) {
                        log(`æç¤º: ${result.message}`);
                    }
                    
                    // æ’­æ”¾éŸ³é¢‘
                    const audioPlayer = document.getElementById('audioPlayer');
                    audioPlayer.src = result.audio_url;
                    audioPlayer.style.display = 'block';
                    
                    // æ·»åŠ æ’­æ”¾äº‹ä»¶ç›‘å¬
                    audioPlayer.onloadeddata = () => {
                        log(`éŸ³é¢‘æ–‡ä»¶åŠ è½½å®Œæˆï¼Œå¼€å§‹æ’­æ”¾: ${result.audio_url}`);
                        audioPlayer.play().catch(err => {
                            log(`è‡ªåŠ¨æ’­æ”¾å¤±è´¥: ${err.message}ï¼Œè¯·æ‰‹åŠ¨ç‚¹å‡»æ’­æ”¾`);
                        });
                    };
                    
                    audioPlayer.onerror = (e) => {
                        log(`éŸ³é¢‘æ’­æ”¾é”™è¯¯: ${e.message || 'æœªçŸ¥é”™è¯¯'}`);
                        showStatus('synthesisStatus', 'error', 'éŸ³é¢‘æ’­æ”¾å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨');
                    };
                    
                    log(`éŸ³é¢‘URLè®¾ç½®å®Œæˆ: ${result.audio_url}`);
                } else {
                    throw new Error('æœªè·å¾—æœ‰æ•ˆçš„éŸ³é¢‘å“åº”');
                }
                
            } catch (error) {
                log(`è¯­éŸ³åˆæˆå¤±è´¥: ${error.message}`);
                showStatus('synthesisStatus', 'error', `åˆæˆå¤±è´¥: ${error.message}`);
            } finally {
                synthesizeBtn.disabled = false;
                synthesizeBtn.textContent = 'ğŸµ æµ‹è¯•è¯­éŸ³åˆæˆ';
            }
        }

        function showStatus(elementId, type, message) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        function log(message) {
            const logArea = document.getElementById('logArea');
            const timestamp = new Date().toLocaleTimeString();
            logArea.innerHTML += `[${timestamp}] ${message}\n`;
            logArea.scrollTop = logArea.scrollHeight;
        }

        function clearLog() {
            document.getElementById('logArea').innerHTML = '';
        }
    </script>
</body>
</html> 