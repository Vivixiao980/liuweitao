<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¯­éŸ³å…‹éš†åŠŸèƒ½æµ‹è¯•</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .test-container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .test-section {
            margin-bottom: 2rem;
            padding: 1.5rem;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
        }
        .test-section h3 {
            margin-bottom: 1rem;
            color: #1e293b;
        }
        .status {
            padding: 0.5rem 1rem;
            border-radius: 6px;
            margin: 0.5rem 0;
            font-weight: 500;
        }
        .status.success { background: #dcfce7; color: #166534; }
        .status.error { background: #fef2f2; color: #dc2626; }
        .status.warning { background: #fef3c7; color: #d97706; }
        .status.info { background: #dbeafe; color: #2563eb; }
        .test-button {
            background: #6366f1;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            margin: 0.5rem;
            transition: all 0.3s ease;
        }
        .test-button:hover {
            background: #5048e5;
            transform: translateY(-1px);
        }
        .test-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .result-box {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 1rem;
            margin-top: 1rem;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .audio-player {
            margin: 1rem 0;
        }
        .clone-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            margin: 0.5rem 0;
        }
        .clone-info {
            flex: 1;
        }
        .clone-actions {
            display: flex;
            gap: 0.5rem;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1><i class="fa fa-microphone"></i> è¯­éŸ³å…‹éš†åŠŸèƒ½æµ‹è¯•</h1>
        
        <!-- ç³»ç»ŸçŠ¶æ€æ£€æŸ¥ -->
        <div class="test-section">
            <h3><i class="fa fa-heartbeat"></i> ç³»ç»ŸçŠ¶æ€æ£€æŸ¥</h3>
            <button class="test-button" onclick="checkSystemStatus()">æ£€æŸ¥ç³»ç»ŸçŠ¶æ€</button>
            <div id="systemStatus"></div>
        </div>

        <!-- MiniMaxé…ç½®æ£€æŸ¥ -->
        <div class="test-section">
            <h3><i class="fa fa-cog"></i> MiniMaxé…ç½®æ£€æŸ¥</h3>
            <button class="test-button" onclick="checkMiniMaxConfig()">æ£€æŸ¥é…ç½®</button>
            <div id="configStatus"></div>
        </div>

        <!-- APIæƒé™æµ‹è¯• -->
        <div class="test-section">
            <h3><i class="fa fa-key"></i> APIæƒé™æµ‹è¯•</h3>
            <button class="test-button" onclick="testAPIPermissions()">æµ‹è¯•æƒé™</button>
            <div id="permissionStatus"></div>
        </div>

        <!-- è¯­éŸ³å…‹éš†åˆ—è¡¨ -->
        <div class="test-section">
            <h3><i class="fa fa-list"></i> è¯­éŸ³å…‹éš†åˆ—è¡¨</h3>
            <button class="test-button" onclick="loadVoiceClones()">åˆ·æ–°åˆ—è¡¨</button>
            <div id="voiceClonesList"></div>
        </div>

        <!-- è¯­éŸ³åˆæˆæµ‹è¯• -->
        <div class="test-section">
            <h3><i class="fa fa-volume-up"></i> è¯­éŸ³åˆæˆæµ‹è¯•</h3>
            <input type="text" id="testText" placeholder="è¾“å…¥æµ‹è¯•æ–‡æœ¬..." value="ä½ å¥½ï¼Œæˆ‘æ˜¯ç¤¼æ˜è€å¸ˆï¼Œå¾ˆé«˜å…´ä¸ºæ‚¨æœåŠ¡ï¼" style="width: 100%; padding: 0.75rem; border: 1px solid #e2e8f0; border-radius: 6px; margin-bottom: 1rem;">
            <br>
            <button class="test-button" onclick="testVoiceSynthesis()">æµ‹è¯•è¯­éŸ³åˆæˆ</button>
            <button class="test-button" onclick="testWebSpeech()">æµ‹è¯•Web Speech</button>
            <div id="synthesisResult"></div>
        </div>

        <!-- å¿«é€Ÿä¿®å¤å·¥å…· -->
        <div class="test-section">
            <h3><i class="fa fa-wrench"></i> å¿«é€Ÿä¿®å¤å·¥å…·</h3>
            <button class="test-button" onclick="resetVoiceConfig()">é‡ç½®è¯­éŸ³é…ç½®</button>
            <button class="test-button" onclick="clearCache()">æ¸…é™¤ç¼“å­˜</button>
            <button class="test-button" onclick="switchToWebSpeech()">åˆ‡æ¢åˆ°Web Speech</button>
            <div id="fixResult"></div>
        </div>
    </div>

    <script>
        // ç³»ç»ŸçŠ¶æ€æ£€æŸ¥
        async function checkSystemStatus() {
            const statusDiv = document.getElementById('systemStatus');
            statusDiv.innerHTML = '<div class="status info">æ­£åœ¨æ£€æŸ¥ç³»ç»ŸçŠ¶æ€...</div>';
            
            try {
                const response = await fetch('/api/voice-config');
                const config = await response.json();
                
                let html = '<div class="status success">âœ… æœåŠ¡å™¨è¿è¡Œæ­£å¸¸</div>';
                html += `<div class="result-box">å½“å‰é…ç½®ï¼š\n${JSON.stringify(config, null, 2)}</div>`;
                
                statusDiv.innerHTML = html;
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">âŒ ç³»ç»Ÿæ£€æŸ¥å¤±è´¥: ${error.message}</div>`;
            }
        }

        // MiniMaxé…ç½®æ£€æŸ¥
        async function checkMiniMaxConfig() {
            const statusDiv = document.getElementById('configStatus');
            statusDiv.innerHTML = '<div class="status info">æ­£åœ¨æ£€æŸ¥MiniMaxé…ç½®...</div>';
            
            try {
                const response = await fetch('/api/voice-config');
                const config = await response.json();
                
                let issues = [];
                let warnings = [];
                
                if (!config.apiKey) {
                    issues.push('ç¼ºå°‘APIå¯†é’¥');
                } else if (config.apiKey.startsWith('eyJ')) {
                    issues.push('APIå¯†é’¥æ ¼å¼é”™è¯¯ï¼ˆJWTä»¤ç‰Œï¼Œéœ€è¦sk-å¼€å¤´çš„æ ‡å‡†å¯†é’¥ï¼‰');
                } else if (!config.apiKey.startsWith('sk-')) {
                    warnings.push('APIå¯†é’¥æ ¼å¼å¯èƒ½ä¸æ­£ç¡®ï¼ˆå»ºè®®ä½¿ç”¨sk-å¼€å¤´çš„å¯†é’¥ï¼‰');
                }
                
                if (!config.groupId) {
                    issues.push('ç¼ºå°‘Group ID');
                }
                
                let html = '';
                if (issues.length === 0) {
                    html += '<div class="status success">âœ… é…ç½®æ£€æŸ¥é€šè¿‡</div>';
                } else {
                    html += '<div class="status error">âŒ é…ç½®å­˜åœ¨é—®é¢˜:</div>';
                    issues.forEach(issue => {
                        html += `<div class="status error">â€¢ ${issue}</div>`;
                    });
                }
                
                warnings.forEach(warning => {
                    html += `<div class="status warning">âš ï¸ ${warning}</div>`;
                });
                
                html += `<div class="result-box">å®Œæ•´é…ç½®ï¼š\n${JSON.stringify(config, null, 2)}</div>`;
                
                statusDiv.innerHTML = html;
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">âŒ é…ç½®æ£€æŸ¥å¤±è´¥: ${error.message}</div>`;
            }
        }

        // APIæƒé™æµ‹è¯•
        async function testAPIPermissions() {
            const statusDiv = document.getElementById('permissionStatus');
            statusDiv.innerHTML = '<div class="status info">æ­£åœ¨æµ‹è¯•APIæƒé™...</div>';
            
            try {
                // æµ‹è¯•è¯­éŸ³åˆæˆ
                const ttsResponse = await fetch('/api/text-to-speech', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: 'æµ‹è¯•' })
                });
                
                let html = '';
                if (ttsResponse.ok) {
                    html += '<div class="status success">âœ… è¯­éŸ³åˆæˆæƒé™æ­£å¸¸</div>';
                } else {
                    const errorData = await ttsResponse.json();
                    html += `<div class="status error">âŒ è¯­éŸ³åˆæˆå¤±è´¥: ${errorData.error}</div>`;
                }
                
                // æµ‹è¯•è¯­éŸ³åˆ—è¡¨è·å–
                const voicesResponse = await fetch('/api/voices');
                if (voicesResponse.ok) {
                    const voicesData = await voicesResponse.json();
                    html += '<div class="status success">âœ… è¯­éŸ³åˆ—è¡¨è·å–æ­£å¸¸</div>';
                    html += `<div class="status info">å¯ç”¨è¯­éŸ³æ•°é‡: ${voicesData.voices?.length || 0}</div>`;
                } else {
                    html += '<div class="status error">âŒ è¯­éŸ³åˆ—è¡¨è·å–å¤±è´¥</div>';
                }
                
                statusDiv.innerHTML = html;
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">âŒ æƒé™æµ‹è¯•å¤±è´¥: ${error.message}</div>`;
            }
        }

        // åŠ è½½è¯­éŸ³å…‹éš†åˆ—è¡¨
        async function loadVoiceClones() {
            const listDiv = document.getElementById('voiceClonesList');
            listDiv.innerHTML = '<div class="status info">æ­£åœ¨åŠ è½½è¯­éŸ³å…‹éš†åˆ—è¡¨...</div>';
            
            try {
                const response = await fetch('/api/voice-clones');
                const data = await response.json();
                
                if (data.success && data.clones.length > 0) {
                    let html = '<div class="status success">âœ… æ‰¾åˆ°è¯­éŸ³å…‹éš†</div>';
                    data.clones.forEach(clone => {
                        html += `
                            <div class="clone-item">
                                <div class="clone-info">
                                    <strong>${clone.name}</strong> (${clone.id})
                                    <br>
                                    <small>åˆ›å»ºæ—¶é—´: ${new Date(clone.created_time).toLocaleString()}</small>
                                    <br>
                                    <small>çŠ¶æ€: ${clone.is_real_clone ? 'çœŸå®å…‹éš†' : 'æœ¬åœ°æ ·æœ¬'}</small>
                                </div>
                                <div class="clone-actions">
                                    <button class="test-button" onclick="testClone('${clone.id}', '${clone.name}')">æµ‹è¯•</button>
                                    <button class="test-button" onclick="setAsDefault('${clone.id}', '${clone.name}')">è®¾ä¸ºé»˜è®¤</button>
                                </div>
                            </div>
                        `;
                    });
                    listDiv.innerHTML = html;
                } else {
                    listDiv.innerHTML = '<div class="status warning">âš ï¸ æ²¡æœ‰æ‰¾åˆ°è¯­éŸ³å…‹éš†</div>';
                }
            } catch (error) {
                listDiv.innerHTML = `<div class="status error">âŒ åŠ è½½å¤±è´¥: ${error.message}</div>`;
            }
        }

        // æµ‹è¯•è¯­éŸ³åˆæˆ
        async function testVoiceSynthesis() {
            const text = document.getElementById('testText').value;
            const resultDiv = document.getElementById('synthesisResult');
            
            if (!text.trim()) {
                resultDiv.innerHTML = '<div class="status error">âŒ è¯·è¾“å…¥æµ‹è¯•æ–‡æœ¬</div>';
                return;
            }
            
            resultDiv.innerHTML = '<div class="status info">æ­£åœ¨ç”Ÿæˆè¯­éŸ³...</div>';
            
            try {
                const response = await fetch('/api/text-to-speech', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: text })
                });
                
                if (response.ok) {
                    const audioBlob = await response.blob();
                    const audioUrl = URL.createObjectURL(audioBlob);
                    
                    let html = '<div class="status success">âœ… è¯­éŸ³ç”ŸæˆæˆåŠŸ</div>';
                    html += `<audio controls class="audio-player" style="width: 100%;">
                                <source src="${audioUrl}" type="audio/mpeg">
                                æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘æ’­æ”¾
                             </audio>`;
                    
                    resultDiv.innerHTML = html;
                } else {
                    const errorData = await response.json();
                    resultDiv.innerHTML = `<div class="status error">âŒ è¯­éŸ³ç”Ÿæˆå¤±è´¥: ${errorData.error}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="status error">âŒ è¯·æ±‚å¤±è´¥: ${error.message}</div>`;
            }
        }

        // æµ‹è¯•Web Speech
        async function testWebSpeech() {
            const text = document.getElementById('testText').value;
            const resultDiv = document.getElementById('synthesisResult');
            
            if (!text.trim()) {
                resultDiv.innerHTML = '<div class="status error">âŒ è¯·è¾“å…¥æµ‹è¯•æ–‡æœ¬</div>';
                return;
            }
            
            if ('speechSynthesis' in window) {
                speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'zh-CN';
                utterance.rate = 1.0;
                utterance.pitch = 1.0;
                
                utterance.onstart = () => {
                    resultDiv.innerHTML = '<div class="status info">ğŸ”Š æ­£åœ¨æ’­æ”¾Web Speechè¯­éŸ³...</div>';
                };
                
                utterance.onend = () => {
                    resultDiv.innerHTML = '<div class="status success">âœ… Web Speechæ’­æ”¾å®Œæˆ</div>';
                };
                
                utterance.onerror = (event) => {
                    resultDiv.innerHTML = `<div class="status error">âŒ Web Speeché”™è¯¯: ${event.error}</div>`;
                };
                
                speechSynthesis.speak(utterance);
            } else {
                resultDiv.innerHTML = '<div class="status error">âŒ æµè§ˆå™¨ä¸æ”¯æŒWeb Speech API</div>';
            }
        }

        // æµ‹è¯•ç‰¹å®šå…‹éš†
        async function testClone(cloneId, cloneName) {
            try {
                await fetch('/api/set-voice', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        voiceId: cloneId, 
                        voiceName: cloneName,
                        platform: 'custom-clone'
                    })
                });
                
                document.getElementById('testText').value = `ä½ å¥½ï¼Œæˆ‘æ˜¯${cloneName}ï¼Œè¿™æ˜¯è¯­éŸ³å…‹éš†æµ‹è¯•ã€‚`;
                testVoiceSynthesis();
            } catch (error) {
                alert('è®¾ç½®è¯­éŸ³å¤±è´¥: ' + error.message);
            }
        }

        // è®¾ä¸ºé»˜è®¤è¯­éŸ³
        async function setAsDefault(cloneId, cloneName) {
            try {
                const response = await fetch('/api/set-voice', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        voiceId: cloneId, 
                        voiceName: cloneName,
                        platform: 'custom-clone'
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    alert(`âœ… å·²è®¾ç½®"${cloneName}"ä¸ºé»˜è®¤è¯­éŸ³`);
                    checkSystemStatus();
                } else {
                    alert('âŒ è®¾ç½®å¤±è´¥: ' + data.error);
                }
            } catch (error) {
                alert('âŒ è®¾ç½®å¤±è´¥: ' + error.message);
            }
        }

        // é‡ç½®è¯­éŸ³é…ç½®
        async function resetVoiceConfig() {
            const resultDiv = document.getElementById('fixResult');
            
            try {
                const response = await fetch('/api/set-voice', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        voiceId: 'female-yujie', 
                        voiceName: 'å¾¡å§éŸ³ï¼ˆå¥³ï¼‰',
                        platform: 'minimax'
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    resultDiv.innerHTML = '<div class="status success">âœ… è¯­éŸ³é…ç½®å·²é‡ç½®ä¸ºé»˜è®¤è®¾ç½®</div>';
                } else {
                    resultDiv.innerHTML = `<div class="status error">âŒ é‡ç½®å¤±è´¥: ${data.error}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="status error">âŒ é‡ç½®å¤±è´¥: ${error.message}</div>`;
            }
        }

        // æ¸…é™¤ç¼“å­˜
        function clearCache() {
            const resultDiv = document.getElementById('fixResult');
            
            // æ¸…é™¤éŸ³é¢‘ç¼“å­˜
            speechSynthesis.cancel();
            
            // æ¸…é™¤é¡µé¢ç¼“å­˜
            if ('caches' in window) {
                caches.keys().then(names => {
                    names.forEach(name => {
                        caches.delete(name);
                    });
                });
            }
            
            resultDiv.innerHTML = '<div class="status success">âœ… ç¼“å­˜å·²æ¸…é™¤</div>';
        }

        // åˆ‡æ¢åˆ°Web Speech
        async function switchToWebSpeech() {
            const resultDiv = document.getElementById('fixResult');
            
            try {
                const response = await fetch('/api/set-voice', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        voiceId: 'web-speech', 
                        voiceName: 'Web Speech',
                        platform: 'web-speech'
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    resultDiv.innerHTML = '<div class="status success">âœ… å·²åˆ‡æ¢åˆ°Web Speechæ¨¡å¼</div>';
                } else {
                    resultDiv.innerHTML = `<div class="status error">âŒ åˆ‡æ¢å¤±è´¥: ${data.error}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="status error">âŒ åˆ‡æ¢å¤±è´¥: ${error.message}</div>`;
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥çŠ¶æ€
        window.onload = function() {
            checkSystemStatus();
            loadVoiceClones();
        };
    </script>
</body>
</html> 