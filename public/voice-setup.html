<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¤¼æ˜è€å¸ˆ - è¯­éŸ³å…‹éš†è®¾ç½®</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .voice-container {
            max-width: 1000px;
            margin: 2rem auto;
            padding: 2rem;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-heavy);
        }
        
        .step-card {
            background: var(--secondary-color);
            border-radius: var(--border-radius);
            padding: 2rem;
            margin-bottom: 2rem;
            border-left: 4px solid var(--primary-color);
        }
        
        .step-number {
            background: var(--primary-color);
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 1rem;
        }
        
        .api-config {
            background: #f8fafc;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1rem 0;
        }
        
        .config-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-family: monospace;
            margin-bottom: 1rem;
        }
        
        .platform-card {
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: var(--transition);
            cursor: pointer;
        }
        
        .platform-card:hover {
            border-color: var(--primary-color);
            box-shadow: var(--shadow-light);
        }
        
        .platform-card.selected {
            border-color: var(--primary-color);
            background: rgba(99, 102, 241, 0.05);
        }
        
        .platform-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .platform-badge {
            background: var(--primary-color);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.8rem;
            margin-left: auto;
        }
        
        .code-block {
            background: #1e293b;
            color: #e2e8f0;
            padding: 1rem;
            border-radius: 8px;
            font-family: monospace;
            font-size: 0.9rem;
            overflow-x: auto;
            margin: 1rem 0;
        }
        
        .warning-box {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            color: #92400e;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }
        
        .success-box {
            background: #f0fdf4;
            border: 1px solid #22c55e;
            color: #166534;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }
        
        .voice-sample {
            background: #f8fafc;
            border: 2px dashed var(--border-color);
            border-radius: var(--border-radius);
            padding: 2rem;
            text-align: center;
            margin: 1rem 0;
        }
        
        .upload-voice {
            padding: 1rem 2rem;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 500;
            margin: 0.5rem;
        }
        
        .test-voice {
            margin-top: 2rem;
            padding: 1.5rem;
            background: var(--secondary-color);
            border-radius: var(--border-radius);
        }
    </style>
</head>
<body>
    <div class="voice-container">
        <a href="/" class="back-link">
            <i class="fa fa-arrow-left"></i>
            è¿”å›å¯¹è¯ç•Œé¢
        </a>
        
        <div class="upload-header">
            <h1>ğŸ™ï¸ ç¤¼æ˜è€å¸ˆè¯­éŸ³å…‹éš†è®¾ç½®</h1>
            <p>é…ç½®è¯­éŸ³å…‹éš†åŠŸèƒ½ï¼Œè®©AIç”¨ç¤¼æ˜è€å¸ˆçš„å£°éŸ³å›å¤</p>
        </div>

        <!-- ç¬¬ä¸€æ­¥ï¼šé€‰æ‹©è¯­éŸ³å¹³å° -->
        <div class="step-card">
            <h2><span class="step-number">1</span>é€‰æ‹©è¯­éŸ³å…‹éš†å¹³å°</h2>
            
            <div class="platform-card" onclick="selectPlatform('elevenlabs')">
                <div class="platform-header">
                    <h3>ğŸš€ ElevenLabs (æ¨è)</h3>
                    <span class="platform-badge">æœ€ä½³æ•ˆæœ</span>
                </div>
                <p>â€¢ è¯­éŸ³è´¨é‡æœ€é«˜ï¼Œæ”¯æŒä¸­æ–‡<br>
                â€¢ åªéœ€3-5åˆ†é’Ÿè¯­éŸ³æ ·æœ¬<br>
                â€¢ å…è´¹é¢åº¦ï¼š10,000å­—ç¬¦/æœˆ<br>
                â€¢ ä»˜è´¹ï¼š$5-22/æœˆ</p>
                <div class="warning-box">
                    <strong>æ³¨æ„ï¼š</strong>éœ€è¦ç§‘å­¦ä¸Šç½‘è®¿é—®
                </div>
            </div>

            <div class="platform-card" onclick="selectPlatform('azure')">
                <div class="platform-header">
                    <h3>â˜ï¸ Azure Speech Services</h3>
                    <span class="platform-badge">ä¼ä¸šçº§</span>
                </div>
                <p>â€¢ å¾®è½¯å®˜æ–¹æœåŠ¡ï¼Œç¨³å®šå¯é <br>
                â€¢ æ”¯æŒè‡ªå®šä¹‰ç¥ç»è¯­éŸ³<br>
                â€¢ å…è´¹é¢åº¦ï¼š50ä¸‡å­—ç¬¦/æœˆ<br>
                â€¢ éœ€è¦è¾ƒå¤šè®­ç»ƒæ•°æ®</p>
            </div>

            <div class="platform-card" onclick="selectPlatform('xunfei')">
                <div class="platform-header">
                    <h3>ğŸ‡¨ğŸ‡³ è®¯é£è¯­éŸ³</h3>
                    <span class="platform-badge">å›½äº§</span>
                </div>
                <p>â€¢ å›½å†…æœåŠ¡ï¼Œç½‘ç»œè®¿é—®å¿«<br>
                â€¢ ä¸­æ–‡æ•ˆæœä¼˜ç§€<br>
                â€¢ æœ‰å…è´¹é¢åº¦<br>
                â€¢ æ”¯æŒä¸ªæ€§åŒ–å®šåˆ¶</p>
            </div>
        </div>

        <!-- ç¬¬äºŒæ­¥ï¼šAPIé…ç½® -->
        <div class="step-card" id="apiConfig" style="display: none;">
            <h2><span class="step-number">2</span>é…ç½®APIå¯†é’¥</h2>
            
            <div id="elevenlabsConfig" style="display: none;">
                <h3>ElevenLabs APIé…ç½®</h3>
                <div class="api-config">
                    <label>API Key:</label>
                    <input type="password" class="config-input" id="elevenlabsKey" placeholder="è¾“å…¥æ‚¨çš„ElevenLabs API Key">
                    
                    <div class="warning-box">
                        <strong>è·å–API Keyæ­¥éª¤ï¼š</strong><br>
                        1. è®¿é—® <a href="https://elevenlabs.io" target="_blank">elevenlabs.io</a><br>
                        2. æ³¨å†Œè´¦å·å¹¶ç™»å½•<br>
                        3. è¿›å…¥ Profile â†’ API Keys<br>
                        4. å¤åˆ¶API Keyåˆ°ä¸Šæ–¹è¾“å…¥æ¡†
                    </div>
                </div>
            </div>

            <div id="azureConfig" style="display: none;">
                <h3>Azure Speech Servicesé…ç½®</h3>
                <div class="api-config">
                    <label>Subscription Key:</label>
                    <input type="password" class="config-input" id="azureKey" placeholder="è¾“å…¥Azureè®¢é˜…å¯†é’¥">
                    
                    <label>Region:</label>
                    <input type="text" class="config-input" id="azureRegion" placeholder="ä¾‹å¦‚: eastus" value="eastus">
                </div>
            </div>

            <div id="xunfeiConfig" style="display: none;">
                <h3>è®¯é£è¯­éŸ³é…ç½®</h3>
                <div class="api-config">
                    <label>AppID:</label>
                    <input type="text" class="config-input" id="xunfeiAppId" placeholder="è¾“å…¥è®¯é£AppID">
                    
                    <label>API Secret:</label>
                    <input type="password" class="config-input" id="xunfeiSecret" placeholder="è¾“å…¥API Secret">
                    
                    <label>API Key:</label>
                    <input type="password" class="config-input" id="xunfeiKey" placeholder="è¾“å…¥API Key">
                </div>
            </div>

            <button class="upload-voice" onclick="saveApiConfig()">ä¿å­˜APIé…ç½®</button>
        </div>

        <!-- ç¬¬ä¸‰æ­¥ï¼šé€‰æ‹©è¯­éŸ³ -->
        <div class="step-card" id="voiceSample" style="display: none;">
            <h2><span class="step-number">3</span>é€‰æ‹©è¯­éŸ³æ¨¡å¼</h2>
            
            <div class="success-box">
                <strong>ğŸ‰ ä»˜è´¹è®¢é˜…å·²æ¿€æ´»ï¼</strong><br>
                æ‚¨ç°åœ¨å¯ä»¥ä½¿ç”¨è¯­éŸ³å…‹éš†åŠŸèƒ½åˆ›å»ºç¤¼æ˜è€å¸ˆçš„ä¸“å±è¯­éŸ³ã€‚<br>
                ä¹Ÿå¯ä»¥ç»§ç»­ä½¿ç”¨é¢„è®¾è¯­éŸ³è¿›è¡Œå¿«é€Ÿæµ‹è¯•ã€‚
            </div>

            <!-- é¢„è®¾è¯­éŸ³é€‰æ‹© -->
            <div class="voice-sample">
                <i class="fa fa-volume-up" style="font-size: 3rem; color: var(--primary-color); margin-bottom: 1rem;"></i>
                <h3>ä½¿ç”¨é¢„è®¾è¯­éŸ³ï¼ˆæ¨èï¼‰</h3>
                <p>é€‰æ‹©ä¸€ä¸ªåˆé€‚çš„ä¸­æ–‡è¯­éŸ³æ¥æ¨¡æ‹Ÿç¤¼æ˜è€å¸ˆ</p>
                
                <div id="voiceSelectContainer" style="margin: 1rem 0;">
                    <label style="font-weight: bold; display: block; margin-bottom: 0.5rem;">é€‰æ‹©è¯­éŸ³ï¼š</label>
                    <select id="voiceSelect" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 1rem;">
                        <option value="">æ­£åœ¨åŠ è½½è¯­éŸ³åˆ—è¡¨...</option>
                    </select>
                </div>
                
                <button class="upload-voice" onclick="setPresetVoice()" style="background: #22c55e;">
                    <i class="fa fa-check"></i> è®¾ç½®ä¸ºé»˜è®¤è¯­éŸ³
                </button>
                <button class="upload-voice" onclick="testSelectedVoice()">
                    <i class="fa fa-play"></i> è¯•å¬è¯­éŸ³
                </button>
            </div>

            <!-- è¯­éŸ³å…‹éš†é€‰é¡¹ï¼ˆä»˜è´¹ç”¨æˆ·å·²å¯ç”¨ï¼‰ -->
            <div class="voice-sample" style="margin-top: 2rem;">
                <i class="fa fa-magic" style="font-size: 3rem; color: var(--primary-color); margin-bottom: 1rem;"></i>
                <h3>ğŸ‰ è¯­éŸ³å…‹éš†ï¼ˆå·²å¯ç”¨ï¼‰</h3>
                <p>ä¸Šä¼ ç¤¼æ˜è€å¸ˆçš„è¯­éŸ³æ ·æœ¬åˆ›å»ºä¸“å±è¯­éŸ³</p>
                
                <div class="success-box" style="margin-bottom: 1rem;">
                    <strong>âœ… ä»˜è´¹è®¢é˜…å·²æ¿€æ´»ï¼</strong><br>
                    ç°åœ¨å¯ä»¥ä¸Šä¼ è¯­éŸ³æ ·æœ¬åˆ›å»ºç¤¼æ˜è€å¸ˆçš„ä¸“å±è¯­éŸ³å…‹éš†
                </div>
                
                <input type="file" id="voiceFile" accept=".mp3,.wav,.m4a" multiple style="display: none;">
                <a href="/voice-clone-guide.html" class="upload-voice" style="text-decoration: none; display: inline-block; background: #8b5cf6;">
                    <i class="fa fa-book"></i> å½•éŸ³æŒ‡å¯¼
                </a>
                <button class="upload-voice" onclick="document.getElementById('voiceFile').click()">
                    <i class="fa fa-upload"></i> é€‰æ‹©éŸ³é¢‘æ–‡ä»¶
                </button>
                <button class="upload-voice" onclick="startRecording()">
                    <i class="fa fa-microphone"></i> å¼€å§‹å½•éŸ³
                </button>
                <button class="upload-voice" onclick="createVoiceClone()" style="background: #22c55e;">
                    <i class="fa fa-magic"></i> åˆ›å»ºè¯­éŸ³å…‹éš†
                </button>
                
                <div class="warning-box" style="margin-top: 1rem;">
                    <strong>ğŸ“‹ è¯­éŸ³æ ·æœ¬è¦æ±‚ï¼š</strong><br>
                    â€¢ æ¸…æ™°çš„ä¸­æ–‡è¯­éŸ³ï¼Œæ— èƒŒæ™¯å™ªéŸ³<br>
                    â€¢ æ—¶é•¿3-10åˆ†é’Ÿä¸ºä½³<br>
                    â€¢ åŒ…å«å¤šç§è¯­è°ƒå’Œæƒ…æ„Ÿ<br>
                    â€¢ æ”¯æŒæ ¼å¼ï¼šMP3, WAV, M4A<br>
                    â€¢ å»ºè®®å½•åˆ¶è‡ªç„¶å¯¹è¯è€Œéæœ—è¯»
                </div>
            </div>

            <div id="recordingStatus" style="display: none;">
                <div class="success-box">
                    <i class="fa fa-microphone"></i> æ­£åœ¨å½•éŸ³... <span id="recordTime">00:00</span>
                    <button onclick="stopRecording()" style="margin-left: 1rem; padding: 0.5rem 1rem;">åœæ­¢å½•éŸ³</button>
                </div>
            </div>
        </div>

        <!-- ç¬¬å››æ­¥ï¼šæµ‹è¯•è¯­éŸ³ -->
        <div class="step-card" id="testVoice" style="display: none;">
            <h2><span class="step-number">4</span>æµ‹è¯•è¯­éŸ³æ•ˆæœ</h2>
            
            <div class="test-voice">
                <h3>è¾“å…¥æµ‹è¯•æ–‡æœ¬</h3>
                <textarea id="testText" placeholder="è¾“å…¥è¦æµ‹è¯•çš„æ–‡æœ¬ï¼Œä¾‹å¦‚ï¼šä½ å¥½ï¼Œæˆ‘æ˜¯ç¤¼æ˜ï¼Œæ‰“è¿‡èƒœä»—ã€æ„¿æ„åˆ†äº«" 
                    style="width: 100%; height: 100px; padding: 1rem; border-radius: 8px; border: 1px solid var(--border-color);"></textarea>
                
                <button class="upload-voice" onclick="generateTestVoice()">
                    <i class="fa fa-play"></i> ç”Ÿæˆè¯­éŸ³
                </button>
                
                <audio id="testAudio" controls style="width: 100%; margin-top: 1rem; display: none;"></audio>
            </div>
        </div>

        <!-- é…ç½®ä»£ç  -->
        <div class="step-card">
            <h2><span class="step-number">5</span>ç³»ç»Ÿé›†æˆä»£ç </h2>
            <p>ä»¥ä¸‹æ˜¯é›†æˆè¯­éŸ³å…‹éš†åŠŸèƒ½çš„ä»£ç ç¤ºä¾‹ï¼š</p>
            
            <h3>åç«¯API (server.js)</h3>
            <div class="code-block">
// æ·»åŠ ElevenLabsè¯­éŸ³åˆæˆ
app.post('/api/text-to-speech', async (req, res) => {
  try {
    const { text, voiceId } = req.body;
    const response = await fetch(`https://api.elevenlabs.io/v1/text-to-speech/${voiceId}`, {
      method: 'POST',
      headers: {
        'Accept': 'audio/mpeg',
        'Content-Type': 'application/json',
        'xi-api-key': process.env.ELEVENLABS_API_KEY
      },
      body: JSON.stringify({
        text: text,
        model_id: 'eleven_multilingual_v2',
        voice_settings: {
          stability: 0.5,
          similarity_boost: 0.5
        }
      })
    });
    
    const audioBuffer = await response.arrayBuffer();
    res.set('Content-Type', 'audio/mpeg');
    res.send(Buffer.from(audioBuffer));
  } catch (error) {
    res.status(500).json({ error: 'è¯­éŸ³ç”Ÿæˆå¤±è´¥' });
  }
});
            </div>

            <h3>å‰ç«¯é›†æˆ (script.js)</h3>
            <div class="code-block">
// ä¿®æ”¹è¯­éŸ³æ’­æ”¾å‡½æ•°
async function speakText(text) {
  if (!isVoiceEnabled) return;
  
  try {
    const response = await fetch('/api/text-to-speech', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ 
        text: text, 
        voiceId: 'your-cloned-voice-id' 
      })
    });
    
    const audioBlob = await response.blob();
    const audioUrl = URL.createObjectURL(audioBlob);
    const audio = new Audio(audioUrl);
    audio.play();
  } catch (error) {
    console.error('è¯­éŸ³æ’­æ”¾å¤±è´¥:', error);
  }
}
            </div>
        </div>

        <div class="success-box">
            <strong>ğŸ‰ å®Œæˆåæ•ˆæœï¼š</strong><br>
            â€¢ ç”¨æˆ·æé—®åï¼ŒAIä¼šç”¨ç¤¼æ˜è€å¸ˆçš„å£°éŸ³å›å¤<br>
            â€¢ è¯­éŸ³è´¨é‡æ¥è¿‘çœŸäººæ°´å¹³<br>
            â€¢ æ”¯æŒä¸­æ–‡è¯­è°ƒå’Œæƒ…æ„Ÿè¡¨è¾¾<br>
            â€¢ å¯ä»¥è°ƒèŠ‚è¯­é€Ÿã€éŸ³è°ƒç­‰å‚æ•°
        </div>
    </div>

    <script>
        let selectedPlatform = null;
        let mediaRecorder = null;
        let recordedBlobs = [];

        function selectPlatform(platform) {
            selectedPlatform = platform;
            
            // ç§»é™¤æ‰€æœ‰é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.platform-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // æ·»åŠ é€‰ä¸­çŠ¶æ€
            event.currentTarget.classList.add('selected');
            
            // æ˜¾ç¤ºAPIé…ç½®
            document.getElementById('apiConfig').style.display = 'block';
            
            // éšè—æ‰€æœ‰é…ç½®
            document.getElementById('elevenlabsConfig').style.display = 'none';
            document.getElementById('azureConfig').style.display = 'none';
            document.getElementById('xunfeiConfig').style.display = 'none';
            
            // æ˜¾ç¤ºå¯¹åº”é…ç½®
            document.getElementById(platform + 'Config').style.display = 'block';
        }

        async function saveApiConfig() {
            if (!selectedPlatform) {
                alert('è¯·å…ˆé€‰æ‹©è¯­éŸ³å¹³å°');
                return;
            }
            
            try {
                let config = {};
                
                if (selectedPlatform === 'elevenlabs') {
                    const apiKey = document.getElementById('elevenlabsKey').value.trim();
                    if (!apiKey) {
                        alert('è¯·è¾“å…¥ElevenLabs API Key');
                        return;
                    }
                    config = {
                        platform: 'elevenlabs',
                        elevenlabsKey: apiKey
                    };
                } else if (selectedPlatform === 'azure') {
                    const subscriptionKey = document.getElementById('azureKey').value.trim();
                    const region = document.getElementById('azureRegion').value.trim();
                    if (!subscriptionKey || !region) {
                        alert('è¯·å¡«å†™å®Œæ•´çš„Azureé…ç½®ä¿¡æ¯');
                        return;
                    }
                    config = {
                        platform: 'azure',
                        azureKey: subscriptionKey,
                        azureRegion: region
                    };
                } else if (selectedPlatform === 'xunfei') {
                    const appId = document.getElementById('xunfeiAppId').value.trim();
                    const apiSecret = document.getElementById('xunfeiSecret').value.trim();
                    const apiKey = document.getElementById('xunfeiKey').value.trim();
                    if (!appId || !apiSecret || !apiKey) {
                        alert('è¯·å¡«å†™å®Œæ•´çš„è®¯é£è¯­éŸ³é…ç½®ä¿¡æ¯');
                        return;
                    }
                    config = {
                        platform: 'xunfei',
                        xunfeiAppId: appId,
                        xunfeiSecret: apiSecret,
                        xunfeiKey: apiKey
                    };
                }
                
                const response = await fetch('/api/voice-config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(config)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('APIé…ç½®ä¿å­˜æˆåŠŸï¼');
                    // æ˜¾ç¤ºè¯­éŸ³æ ·æœ¬ä¸Šä¼ 
                    document.getElementById('voiceSample').style.display = 'block';
                    document.getElementById('testVoice').style.display = 'block';
                    
                    // å¦‚æœæ˜¯ElevenLabsï¼ŒåŠ è½½å¯ç”¨è¯­éŸ³åˆ—è¡¨
                    if (selectedPlatform === 'elevenlabs') {
                        loadVoices();
                    }
                } else {
                    alert('ä¿å­˜å¤±è´¥ï¼š' + result.error);
                }
            } catch (error) {
                console.error('ä¿å­˜é…ç½®å¤±è´¥:', error);
                alert('ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            }
        }

        // å½•éŸ³åŠŸèƒ½
        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                recordedBlobs = [];

                mediaRecorder.addEventListener('dataavailable', event => {
                    if (event.data && event.data.size > 0) {
                        recordedBlobs.push(event.data);
                    }
                });

                mediaRecorder.start();
                document.getElementById('recordingStatus').style.display = 'block';
                
                // å¼€å§‹è®¡æ—¶
                let seconds = 0;
                const timer = setInterval(() => {
                    seconds++;
                    const minutes = Math.floor(seconds / 60);
                    const secs = seconds % 60;
                    document.getElementById('recordTime').textContent = 
                        `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                }, 1000);

                mediaRecorder.addEventListener('stop', () => {
                    clearInterval(timer);
                    document.getElementById('recordingStatus').style.display = 'none';
                    
                    const blob = new Blob(recordedBlobs, { type: 'audio/wav' });
                    const url = URL.createObjectURL(blob);
                    
                    // è¿™é‡Œå¯ä»¥ä¸Šä¼ å½•éŸ³åˆ°æœåŠ¡å™¨
                    alert('å½•éŸ³å®Œæˆï¼å¯ä»¥è¿›è¡Œè¯­éŸ³å…‹éš†è®­ç»ƒäº†ã€‚');
                });

            } catch (error) {
                alert('æ— æ³•è®¿é—®éº¦å…‹é£ï¼š' + error.message);
            }
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
            }
        }

        async function generateTestVoice() {
            const text = document.getElementById('testText').value;
            if (!text.trim()) {
                alert('è¯·è¾“å…¥æµ‹è¯•æ–‡æœ¬');
                return;
            }
            
            try {
                const response = await fetch('/api/text-to-speech', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ text: text })
                });
                
                if (response.ok && response.headers.get('content-type') === 'audio/mpeg') {
                    const audioBlob = await response.blob();
                    const audioUrl = URL.createObjectURL(audioBlob);
                    
                    const audioElement = document.getElementById('testAudio');
                    audioElement.src = audioUrl;
                    audioElement.style.display = 'block';
                    
                    audioElement.onended = () => {
                        URL.revokeObjectURL(audioUrl);
                    };
                    
                    alert('è¯­éŸ³ç”ŸæˆæˆåŠŸï¼è¯·ç‚¹å‡»æ’­æ”¾æŒ‰é’®è¯•å¬ã€‚');
                } else {
                    const result = await response.json();
                    alert('è¯­éŸ³ç”Ÿæˆå¤±è´¥ï¼š' + (result.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                console.error('æµ‹è¯•è¯­éŸ³å¤±è´¥:', error);
                alert('æµ‹è¯•å¤±è´¥ï¼Œè¯·æ£€æŸ¥APIé…ç½®å’Œç½‘ç»œè¿æ¥');
            }
        }

        // åŠ è½½å¯ç”¨è¯­éŸ³åˆ—è¡¨
        async function loadVoices() {
            try {
                const response = await fetch('/api/voices');
                const result = await response.json();
                
                if (result.success && result.voices.voices) {
                    const voiceSelect = document.getElementById('voiceSelect');
                    voiceSelect.innerHTML = '<option value="">è¯·é€‰æ‹©è¯­éŸ³...</option>';
                    
                    // æ¨èçš„ä¸­æ–‡è¯­éŸ³
                    const recommendedVoices = [
                        'onwK4e9ZLuTAKqWW03F9', // Daniel (è‹±æ–‡ï¼Œä½†ä¸­æ–‡æ•ˆæœä¸é”™)
                        'pNInz6obpgDQGcFmaJgB', // Adam (è‹±æ–‡)
                        'EXAVITQu4vr4xnSDxMaL', // Bella (è‹±æ–‡)
                    ];
                    
                    result.voices.voices.forEach(voice => {
                        const option = document.createElement('option');
                        option.value = voice.voice_id;
                        
                        let displayName = voice.name;
                        if (recommendedVoices.includes(voice.voice_id)) {
                            displayName += ' (æ¨èä¸­æ–‡)';
                        }
                        
                        option.textContent = `${displayName} (${voice.category || 'Unknown'})`;
                        voiceSelect.appendChild(option);
                    });
                    
                    // é»˜è®¤é€‰æ‹©æ¨èçš„ä¸­æ–‡è¯­éŸ³
                    if (recommendedVoices[0]) {
                        voiceSelect.value = recommendedVoices[0];
                    }
                }
            } catch (error) {
                console.error('åŠ è½½è¯­éŸ³åˆ—è¡¨å¤±è´¥:', error);
                const voiceSelect = document.getElementById('voiceSelect');
                voiceSelect.innerHTML = '<option value="">åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥</option>';
            }
        }

        // è®¾ç½®é¢„è®¾è¯­éŸ³
        async function setPresetVoice() {
            const voiceSelect = document.getElementById('voiceSelect');
            const selectedVoiceId = voiceSelect.value;
            
            if (!selectedVoiceId) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè¯­éŸ³');
                return;
            }
            
            try {
                // è·å–å½“å‰é…ç½®
                const configResponse = await fetch('/api/voice-config');
                const currentConfig = await configResponse.json();
                
                // æ›´æ–°è¯­éŸ³ID
                const newConfig = {
                    ...currentConfig,
                    voiceId: selectedVoiceId,
                    voiceName: voiceSelect.options[voiceSelect.selectedIndex].text
                };
                
                const response = await fetch('/api/voice-config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(newConfig)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('âœ… é»˜è®¤è¯­éŸ³è®¾ç½®æˆåŠŸï¼\nç°åœ¨å¯¹è¯ä¸­ä¼šä½¿ç”¨é€‰æ‹©çš„è¯­éŸ³ã€‚');
                    
                    // è‡ªåŠ¨å¡«å…¥æµ‹è¯•æ–‡æœ¬
                    document.getElementById('testText').value = 'ä½ å¥½ï¼Œæˆ‘æ˜¯ç¤¼æ˜ï¼Œæ‰“è¿‡èƒœä»—ã€æ„¿æ„åˆ†äº«ã€‚';
                } else {
                    alert('è®¾ç½®å¤±è´¥ï¼š' + result.error);
                }
            } catch (error) {
                console.error('è®¾ç½®è¯­éŸ³å¤±è´¥:', error);
                alert('è®¾ç½®å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            }
        }

        // è¯•å¬é€‰ä¸­çš„è¯­éŸ³
        async function testSelectedVoice() {
            const voiceSelect = document.getElementById('voiceSelect');
            const selectedVoiceId = voiceSelect.value;
            
            if (!selectedVoiceId) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè¯­éŸ³');
                return;
            }
            
            const testText = 'ä½ å¥½ï¼Œæˆ‘æ˜¯ç¤¼æ˜ï¼Œæ‰“è¿‡èƒœä»—ã€æ„¿æ„åˆ†äº«ã€‚';
            
            try {
                const response = await fetch('/api/text-to-speech', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        text: testText,
                        voiceId: selectedVoiceId 
                    })
                });
                
                if (response.ok && response.headers.get('content-type') === 'audio/mpeg') {
                    const audioBlob = await response.blob();
                    const audioUrl = URL.createObjectURL(audioBlob);
                    
                    const audio = new Audio(audioUrl);
                    audio.play();
                    
                    audio.onended = () => {
                        URL.revokeObjectURL(audioUrl);
                    };
                    
                    alert('ğŸ”Š æ­£åœ¨æ’­æ”¾è¯•å¬ï¼Œè¯·æ³¨æ„å¬æ•ˆæœï¼');
                } else {
                    const result = await response.json();
                    alert('è¯•å¬å¤±è´¥ï¼š' + (result.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                console.error('è¯•å¬å¤±è´¥:', error);
                alert('è¯•å¬å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            }
        }

        // åˆ›å»ºè¯­éŸ³å…‹éš†
        async function createVoiceClone() {
            const voiceFiles = document.getElementById('voiceFile').files;
            if (!voiceFiles || voiceFiles.length === 0) {
                alert('è¯·å…ˆä¸Šä¼ è¯­éŸ³æ ·æœ¬æ–‡ä»¶\n\nå»ºè®®ï¼š\nâ€¢ ä¸Šä¼ 3-10åˆ†é’Ÿçš„æ¸…æ™°è¯­éŸ³\nâ€¢ åŒ…å«å¤šç§è¯­è°ƒå’Œæƒ…æ„Ÿ\nâ€¢ é¿å…èƒŒæ™¯å™ªéŸ³');
                return;
            }
            
            // æ£€æŸ¥æ–‡ä»¶æ•°é‡
            if (voiceFiles.length > 10) {
                alert('æœ€å¤šåªèƒ½ä¸Šä¼ 10ä¸ªéŸ³é¢‘æ–‡ä»¶');
                return;
            }
            
            // æ£€æŸ¥æ–‡ä»¶æ ¼å¼å’Œå¤§å°
            const allowedFormats = ['mp3', 'wav', 'm4a', 'mp4'];
            let totalSize = 0;
            for (let file of voiceFiles) {
                const extension = file.name.split('.').pop().toLowerCase();
                if (!allowedFormats.includes(extension)) {
                    alert(`ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼: ${file.name}\nè¯·ä½¿ç”¨MP3ã€WAVæˆ–M4Aæ ¼å¼`);
                    return;
                }
                totalSize += file.size;
            }
            
            // æ£€æŸ¥æ€»æ–‡ä»¶å¤§å°ï¼ˆé™åˆ¶100MBï¼‰
            if (totalSize > 100 * 1024 * 1024) {
                alert(`æ–‡ä»¶æ€»å¤§å°è¿‡å¤§: ${(totalSize / 1024 / 1024).toFixed(1)}MB\nè¯·ç¡®ä¿æ€»å¤§å°ä¸è¶…è¿‡100MB`);
                return;
            }
            
            // ç¡®è®¤åˆ›å»º
            const confirmed = confirm(`å‡†å¤‡åˆ›å»ºè¯­éŸ³å…‹éš†ï¼š\n\næ–‡ä»¶æ•°é‡: ${voiceFiles.length} ä¸ª\næ€»å¤§å°: ${(totalSize / 1024 / 1024).toFixed(1)}MB\n\nè¿™å°†ä½¿ç”¨æ‚¨çš„ElevenLabsä»˜è´¹é¢åº¦ã€‚\nç¡®å®šè¦ç»§ç»­å—ï¼Ÿ`);
            if (!confirmed) return;
            
            const formData = new FormData();
            formData.append('voiceName', 'ç¤¼æ˜è€å¸ˆ');
            formData.append('voiceDescription', 'ç¤¼æ˜è€å¸ˆçš„ä¸“å±è¯­éŸ³å…‹éš† - æ‰“è¿‡èƒœä»—ã€æ„¿æ„åˆ†äº«');
            
            for (let i = 0; i < voiceFiles.length; i++) {
                formData.append('voiceSamples', voiceFiles[i]);
            }
            
            // æ˜¾ç¤ºè¿›åº¦æç¤º
            const createButton = event.target;
            const originalText = createButton.innerHTML;
            createButton.innerHTML = '<i class="fa fa-spinner fa-spin"></i> åˆ›å»ºä¸­...';
            createButton.disabled = true;
            
            // æ˜¾ç¤ºè¿›åº¦çŠ¶æ€
            const statusDiv = document.createElement('div');
            statusDiv.className = 'status info';
            statusDiv.innerHTML = 'ğŸ”„ æ­£åœ¨ä¸Šä¼ è¯­éŸ³æ–‡ä»¶å¹¶åˆ›å»ºå…‹éš†ï¼Œè¿™å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿæ—¶é—´...';
            createButton.parentNode.insertBefore(statusDiv, createButton.nextSibling);
            
            try {
                const response = await fetch('/api/create-voice', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    statusDiv.className = 'status success';
                    statusDiv.innerHTML = `âœ… è¯­éŸ³å…‹éš†åˆ›å»ºæˆåŠŸï¼è¯­éŸ³ID: ${result.voiceId}`;
                    
                    alert(`ğŸ‰ è¯­éŸ³å…‹éš†åˆ›å»ºæˆåŠŸï¼\n\nè¯­éŸ³åç§°: ${result.voice.name || 'ç¤¼æ˜è€å¸ˆ'}\nè¯­éŸ³ID: ${result.voiceId}\n\nç°åœ¨å¯ä»¥åœ¨å¯¹è¯ä¸­ä½¿ç”¨ç¤¼æ˜è€å¸ˆçš„çœŸå®å£°éŸ³äº†ï¼\n\nå»ºè®®ï¼šå…ˆåœ¨æµ‹è¯•åŒºåŸŸè¯•å¬æ•ˆæœ`);
                    
                    // åˆ·æ–°è¯­éŸ³åˆ—è¡¨
                    await loadVoices();
                    
                    // è‡ªåŠ¨è®¾ç½®ä¸ºé»˜è®¤è¯­éŸ³
                    try {
                        const configResponse = await fetch('/api/voice-config');
                        const currentConfig = await configResponse.json();
                        
                        const newConfig = {
                            ...currentConfig,
                            voiceId: result.voiceId,
                            voiceName: 'ç¤¼æ˜è€å¸ˆï¼ˆè‡ªå®šä¹‰å…‹éš†ï¼‰'
                        };
                        
                        await fetch('/api/voice-config', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(newConfig)
                        });
                        
                        // è‡ªåŠ¨å¡«å…¥æµ‹è¯•æ–‡æœ¬
                        document.getElementById('testText').value = 'ä½ å¥½ï¼Œæˆ‘æ˜¯ç¤¼æ˜ï¼Œæ‰“è¿‡èƒœä»—ã€æ„¿æ„åˆ†äº«ã€‚è¿™æ˜¯æˆ‘çš„ä¸“å±è¯­éŸ³å…‹éš†æµ‹è¯•ã€‚';
                        
                    } catch (configError) {
                        console.error('è®¾ç½®é»˜è®¤è¯­éŸ³å¤±è´¥:', configError);
                    }
                    
                } else {
                    statusDiv.className = 'status error';
                    statusDiv.innerHTML = `âŒ è¯­éŸ³å…‹éš†å¤±è´¥: ${result.error}`;
                    alert(`è¯­éŸ³å…‹éš†å¤±è´¥ï¼š${result.error}\n\nå¯èƒ½çš„åŸå› ï¼š\nâ€¢ è¯­éŸ³æ–‡ä»¶è´¨é‡ä¸å¤Ÿ\nâ€¢ ç½‘ç»œè¿æ¥é—®é¢˜\nâ€¢ APIé…é¢ä¸è¶³\n\nè¯·æ£€æŸ¥åé‡è¯•`);
                }
            } catch (error) {
                console.error('åˆ›å»ºè¯­éŸ³å…‹éš†å¤±è´¥:', error);
                statusDiv.className = 'status error';
                statusDiv.innerHTML = `âŒ åˆ›å»ºå¤±è´¥: ${error.message}`;
                alert(`åˆ›å»ºå¤±è´¥ï¼š${error.message}\n\nè¯·æ£€æŸ¥ï¼š\n1. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸\n2. æ–‡ä»¶æ ¼å¼æ˜¯å¦æ­£ç¡®\n3. ElevenLabs APIæ˜¯å¦æ­£å¸¸\n4. ä»˜è´¹è®¢é˜…æ˜¯å¦æœ‰æ•ˆ`);
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                createButton.innerHTML = originalText;
                createButton.disabled = false;
                
                // 3ç§’åç§»é™¤çŠ¶æ€æç¤º
                setTimeout(() => {
                    if (statusDiv.parentNode) {
                        statusDiv.parentNode.removeChild(statusDiv);
                    }
                }, 10000);
            }
        }

        // æ–‡ä»¶ä¸Šä¼ å¤„ç†
        document.getElementById('voiceFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                alert(`å·²é€‰æ‹©æ–‡ä»¶ï¼š${file.name}\nå¤§å°ï¼š${(file.size / 1024 / 1024).toFixed(2)}MB`);
            }
        });
    </script>
</body>
</html> 